# .ebextensions/08_debug_settings.config
files:
  "/tmp/update_django_settings.py":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/usr/bin/env python3
      import os
      
      # Output the hostname for debugging network issues
      print(f"Hostname: {os.uname().nodename}")
      
      # Check if we can access the database directly
      import socket
      db_host = "movementor-django-db.cfuoimgmmxni.us-west-1.rds.amazonaws.com"
      db_port = 5432
      
      try:
          print(f"Testing connection to {db_host}:{db_port} from the container...")
          sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
          sock.settimeout(5)
          result = sock.connect_ex((db_host, db_port))
          if result == 0:
              print("Connection successful from container!")
          else:
              print(f"Connection failed with error code: {result}")
          sock.close()
      except Exception as e:
          print(f"Exception occurred: {e}")

container_commands:
  01_run_django_debug:
    command: "docker exec $(docker ps -q) python /tmp/update_django_settings.py > /var/log/django_debug.log 2>&1 || echo 'Debug script failed' > /var/log/django_debug_error.log"
    ignoreErrors: true