# .ebextensions/07_enhanced_diagnostics.config
files:
  "/tmp/enhanced_db_check.py":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/usr/bin/env python3
      import os
      import subprocess
      import socket
      import sys
      import json
      
      # Database info from settings.py
      db_host = "movementor-django-db.cfuoimgmmxni.us-west-1.rds.amazonaws.com"
      db_port = 5432
      db_name = "movementor_django_db"
      db_user = "MoveMentor"
      
      print(f"Testing basic TCP connection to {db_host}:{db_port}...")
      try:
          sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
          sock.settimeout(5)
          result = sock.connect_ex((db_host, db_port))
          if result == 0:
              print("TCP connection successful!")
          else:
              print(f"TCP connection failed with error code: {result}")
          sock.close()
      except Exception as e:
          print(f"TCP connection exception: {e}")
      
      # Check container environment
      print("\nContainer environment:")
      try:
          subprocess.run(["docker", "ps"], capture_output=True, text=True)
          print("Docker container status:")
          subprocess.run(["docker", "ps"], text=True)
      except Exception as e:
          print(f"Error getting container info: {e}")
      
      # Check Django configuration
      print("\nDjango environment:")
      try:
          env_vars = {k: v for k, v in os.environ.items() if 'SECRET' not in k.upper()}
          print(f"Environment variables: {json.dumps(env_vars, indent=2)}")
      except Exception as e:
          print(f"Error getting environment info: {e}")
      
      print("\nNetwork diagnostic complete.")

container_commands:
  01_run_enhanced_diagnostics:
    command: "python /tmp/enhanced_db_check.py > /var/log/enhanced_db_diagnostic.log 2>&1"
    ignoreErrors: true